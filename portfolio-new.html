<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>포트폴리오 등록</title>

  <!-- 폰트/아이콘 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css">

  <!-- 전역/페이지 CSS -->
  <link rel="stylesheet" href="css/main.css?v=20250905">
  <link rel="stylesheet" href="css/portfolio-new.css?v=20250905">
</head>
<body>
  <header class="lv-appbar"><div class="lv-title">포트폴리오 등록</div></header>

  <main class="container">
    <div id="pfMsg" class="notice" style="margin:8px 0;"></div>

<section class="pf-section">
  <div class="pf-hero">
    <button id="coverTrigger" type="button" class="pf-coverBtn is-empty">
      <img id="coverPrev" alt="">
      <span class="pf-overlay"><i class="ri-landscape-line"></i></span>
    </button>
  </div>
  <div class="pf-profileRow">
    <div class="pf-avatarWrap">
      <button id="mainTrigger" type="button" class="pf-avatarBtn is-empty">
        <img id="mainPrev" alt="">
        <span class="pf-overlay"><i class="ri-image-add-line"></i></span>
      </button>
    </div>
    <div class="pf-nameBlock">
      <div class="pf-displayName" id="pfNamePreview"></div>
      <div class="pf-headlinePreview" id="pfHeadlinePreview"></div>
    </div>
  </div>
</section>

    <form id="pfForm" class="pf-form">
      <!-- 미리보기 -->
      <section class="pf-section">
        <h3>미리보기</h3>
        <div style="display:flex;align-items:center;gap:12px;">
          <button type="button" id="mainTrigger" class="btn"><i class="ri-image-add-line"></i> 메인 썸네일</button>
          <img id="mainPrev" alt="" style="width:72px;height:72px;border-radius:12px;object-fit:cover;display:none;">
          <button type="button" id="coverTrigger" class="btn"><i class="ri-landscape-line"></i> 배경 이미지</button>
          <img id="coverPrev" alt="" style="width:120px;height:68px;border-radius:10px;object-fit:cover;display:none;">
        </div>
        <input id="mainFile" type="file" accept="image/*" class="file-ghost">
        <input id="coverFile" type="file" accept="image/*" class="file-ghost">
      </section>

      <section class="pf-section">
        <h3>서브 썸네일(선택, 최대 5)</h3>
        <div id="subsGrid" class="subs-grid"></div>
        <button type="button" id="subsTrigger" class="pf-addThumb" aria-label="서브 이미지 추가">
          <i class="ri-image-add-line"></i>
        </button>
        <input id="subsFile" type="file" accept="image/*" multiple class="file-ghost">
      </section>

      <section class="pf-section">
        <h3>기본 정보</h3>
        <label class="label">닉네임 <span class="req">*</span></label>
        <input id="nickname" class="input" placeholder="예: 라이브크리에이터" required>

        <label class="label">한 줄 소개 <span class="req">*</span></label>
        <input id="headline" class="input" placeholder="예: 뷰티/일상 라이브 진행자" required>

        <label class="label">상세 소개 (자유)</label>
        <textarea id="bio" class="input" rows="6" placeholder="자유롭게 소개를 작성하세요."></textarea>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
          <div>
            <label class="label">경력(년)</label>
            <input id="careerYears" class="input" type="number" min="0" max="50" placeholder="0">
          </div>
          <div>
            <label class="label">나이</label>
            <input id="age" class="input" type="number" min="14" max="99" placeholder="24">
          </div>
        </div>

        <label class="label">대표 링크</label>
        <input id="primaryLink" class="input" type="url" placeholder="https://...">

        <label class="label">공개 범위</label>
        <select id="visibility" class="input">
          <option value="public">전체공개</option>
          <option value="unlisted">링크공개</option>
          <option value="private">비공개</option>
        </select>

        <label class="label" style="display:flex;align-items:center;gap:6px;margin-top:6px;">
          <input type="checkbox" id="openToOffers" checked> 제안 받기
        </label>
      </section>

      <section class="pf-section">
        <h3>최근 라이브 링크</h3>
        <div id="linksWrap" class="links-wrap"></div>
        <button type="button" id="addLinkBtn" class="btn"><i class="ri-add-line"></i> 추가</button>
      </section>

      <section class="pf-section">
        <h3>태그</h3>
        <div class="tag-row">
          <input id="tagInput" class="input" placeholder="엔터로 추가">
          <div id="tagList" class="chips"></div>
        </div>
      </section>

      <div class="pf-section btns">
        <button type="button" id="saveDraftBtn" class="btn">임시저장</button>
        <button type="button" id="publishBtn" class="btn pri">발행</button>
      </div>
    </form>
  </main>

  <script src="js/config.js"></script>
  <!-- 최신 스크립트(레거시 name 절대 전송 안 함) -->
  <script src="js/portfolio-new.js?v=FINAL_20250905c"></script>
<script>
/* mobile debug widget for portfolio-new — paste near </body> */
(function(){
  if(!/(\?|&)debug=1(&|$)/.test(location.search)) return;

  const CFG = window.LIVEE_CONFIG || {};
  const API_BASE = (CFG.API_BASE || '/api/v1').replace(/\/$/, '');
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  const token = localStorage.getItem('livee_token') || localStorage.getItem('liveeToken') || '';

  const css = `
  #pfDbg{position:fixed;inset:auto 8px 8px auto;z-index:99999;background:#111;color:#fff;
    font:12px/1.4 -apple-system,BlinkMacSystemFont,Roboto,SUIT,sans-serif;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35);}
  #pfDbg header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #2a2a2a}
  #pfDbg .body{max-height:52vh;overflow:auto;padding:8px 10px}
  #pfDbg table{border-collapse:collapse;width:100%} #pfDbg td{padding:4px 6px;border-bottom:1px solid #222;vertical-align:top}
  #pfDbg .k{opacity:.7;white-space:nowrap} #pfDbg .v{word-break:break-all}
  #pfDbg button{margin-left:6px;background:#2b6ef6;border:0;color:#fff;padding:6px 8px;border-radius:7px}
  #pfDbg .ghost{background:#2b2b2b} #pfDbg .ok{background:#20a35b}
  `;
  const style = document.createElement('style'); style.textContent = css; document.head.appendChild(style);

  const el = document.createElement('div');
  el.id = 'pfDbg';
  el.innerHTML = `
    <header>
      <strong>PF Debug</strong>
      <div>
        <button class="ghost" id="pfDbgReload">새로고침</button>
        <button class="ok" id="pfDbgFix">헤드라인 강제 저장</button>
        <button class="ghost" id="pfDbgClose">닫기</button>
      </div>
    </header>
    <div class="body"><div>로드 중…</div></div>
  `;
  document.body.appendChild(el);
  const body = el.querySelector('.body');

  const strip = (s='')=> String(s||'').replace(/<[^>]*>/g,' ').replace(/\s+/g,' ').trim();
  const pickHeadline = (d)=> (d.headline && String(d.headline).trim())
                          || d.intro || d.introduction || d.oneLiner || d.summary
                          || (d.bio ? strip(d.bio).slice(0,60) : '') || '';

  async function load(){
    if(!id){ body.innerHTML = '<div>쿼리스트링에 id가 없습니다.</div>'; return; }
    try{
      const r = await fetch(`${API_BASE}/portfolio-test/${id}`, { headers:{Accept:'application/json'} });
      const j = await r.json().catch(()=>({}));
      const d = j.data || j || {};
      const eff = pickHeadline(d);
      const rows = [
        ['raw.headline', d.headline ?? ''],
        ['fallback.effective', eff],
        ['bio.length', (d.bio||'').length],
        ['nickname', d.nickname||''],
        ['status', d.status||''],
        ['visibility', d.visibility||''],
        ['id', d.id || d._id || id]
      ].map(([k,v])=> `<tr><td class="k">${k}</td><td class="v">${String(v)}</td></tr>`).join('');
      body.innerHTML = `<table>${rows}</table>`;
      // 폼 필드가 있으면 즉시 채우기(수정화면에서 빈칸 방지)
      const fld = document.querySelector('#headline, [name="headline"]');
      if (fld && !fld.value) fld.value = eff;
    }catch(e){
      body.innerHTML = `<div>오류: ${e.message||e}</div>`;
    }
  }

  async function fix(){
    if(!id) return alert('id 없음');
    if(!token) return alert('로그인 토큰 없음');
    // 화면에서 보이는 값 우선 → 없으면 폴백 계산
    const inputVal = document.querySelector('#headline, [name="headline"]')?.value?.trim();
    let value = inputVal || '';
    if(!value){
      // 서버에서 다시 가져와 폴백 계산
      const r = await fetch(`${API_BASE}/portfolio-test/${id}`, { headers:{Accept:'application/json'} });
      const j = await r.json().catch(()=>({})); const d = j.data || j || {};
      value = pickHeadline(d) || '임시 한줄소개';
    }
    const res = await fetch(`${API_BASE}/portfolio-test/${id}`, {
      method:'PUT',
      headers:{ 'Content-Type':'application/json', 'Accept':'application/json', 'Authorization':`Bearer ${token}` },
      body: JSON.stringify({ headline: value, status: (document.querySelector('#publishBtn')? 'published' : undefined) })
    });
    const jj = await res.json().catch(()=>({}));
    if(!res.ok || jj.ok===false) return alert('저장 실패: ' + (jj.message||res.status));
    alert('헤드라인 저장 완료: ' + (jj?.data?.headline || value));
    await load();
  }

  el.querySelector('#pfDbgReload').onclick = load;
  el.querySelector('#pfDbgFix').onclick = fix;
  el.querySelector('#pfDbgClose').onclick = ()=> el.remove();

  load();
})();
</script>


</body>
</html>